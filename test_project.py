"""
Script de testing integral para el proyecto Avatar Image Processor
Prueba todos los componentes y configuraciones del sistema.
"""

import os
import sys
import traceback
from pathlib import Path

# Agregar el directorio actual al path
sys.path.append(str(Path(__file__).parent))

def test_imports():
    """Prueba que todos los imports funcionen correctamente."""
    print("üß™ Probando imports del proyecto...")
    print("-" * 40)
    
    tests = []
    
    # Test imports b√°sicos
    try:
        from config import Config
        tests.append(("‚úÖ", "config.Config"))
    except Exception as e:
        tests.append(("‚ùå", f"config.Config: {e}"))
    
    try:
        from bg_remover_config import BackgroundRemoverConfig
        tests.append(("‚úÖ", "bg_remover_config.BackgroundRemoverConfig"))
    except Exception as e:
        tests.append(("‚ùå", f"bg_remover_config.BackgroundRemoverConfig: {e}"))
    
    # Test imports del src
    try:
        from src.background_remover import BackgroundRemover
        tests.append(("‚úÖ", "src.background_remover.BackgroundRemover"))
    except Exception as e:
        tests.append(("‚ùå", f"src.background_remover.BackgroundRemover: {e}"))
    
    try:
        from src.remove_bg_service import RemoveBgService
        tests.append(("‚úÖ", "src.remove_bg_service.RemoveBgService"))
    except Exception as e:
        tests.append(("‚ùå", f"src.remove_bg_service.RemoveBgService: {e}"))
    
    try:
        from src.tutanchacon_bg_remover import TutanchaconBgRemover
        tests.append(("‚úÖ", "src.tutanchacon_bg_remover.TutanchaconBgRemover"))
    except Exception as e:
        tests.append(("‚ùå", f"src.tutanchacon_bg_remover.TutanchaconBgRemover: {e}"))
    
    try:
        from src.background_remover_factory import BackgroundRemoverFactory
        tests.append(("‚úÖ", "src.background_remover_factory.BackgroundRemoverFactory"))
    except Exception as e:
        tests.append(("‚ùå", f"src.background_remover_factory.BackgroundRemoverFactory: {e}"))
    
    try:
        from src.proportional_image_resizer import ProportionalImageResizer
        tests.append(("‚úÖ", "src.proportional_image_resizer.ProportionalImageResizer"))
    except Exception as e:
        tests.append(("‚ùå", f"src.proportional_image_resizer.ProportionalImageResizer: {e}"))
    
    try:
        from src.face_detector import FaceDetector
        tests.append(("‚úÖ", "src.face_detector.FaceDetector"))
    except Exception as e:
        tests.append(("‚ùå", f"src.face_detector.FaceDetector: {e}"))
    
    try:
        from src.image_processor import ImageProcessor
        tests.append(("‚úÖ", "src.image_processor.ImageProcessor"))
    except Exception as e:
        tests.append(("‚ùå", f"src.image_processor.ImageProcessor: {e}"))
    
    # Mostrar resultados
    passed = 0
    for status, message in tests:
        print(f"  {status} {message}")
        if status == "‚úÖ":
            passed += 1
    
    print(f"\\nüìä Imports: {passed}/{len(tests)} exitosos")
    return passed == len(tests)

def test_configuration():
    """Prueba la configuraci√≥n del proyecto."""
    print("\\nüîß Probando configuraci√≥n...")
    print("-" * 40)
    
    try:
        from config import Config
        
        # Mostrar configuraci√≥n
        Config.print_configuration()
        
        # Validar configuraci√≥n
        Config.validate_configuration()
        
        print("‚úÖ Configuraci√≥n v√°lida")
        return True
        
    except Exception as e:
        print(f"‚ùå Error en configuraci√≥n: {e}")
        traceback.print_exc()
        return False

def test_bg_remover_config():
    """Prueba la configuraci√≥n del removedor de fondos."""
    print("\\nüé® Probando configuraci√≥n de removedor de fondos...")
    print("-" * 50)
    
    try:
        from bg_remover_config import BackgroundRemoverConfig
        
        # Mostrar configuraci√≥n actual
        BackgroundRemoverConfig.print_current_config()
        
        # Probar cambio de preset
        print("\\nüîÑ Probando cambio de preset...")
        original_preset = BackgroundRemoverConfig.ACTIVE_PRESET
        
        BackgroundRemoverConfig.set_preset('avatar_equilibrado')
        config = BackgroundRemoverConfig.get_tutanchacon_config()
        print(f"‚úÖ Preset 'avatar_equilibrado': {config}")
        
        # Restaurar preset original
        BackgroundRemoverConfig.ACTIVE_PRESET = original_preset
        
        print("‚úÖ Configuraci√≥n de removedor v√°lida")
        return True
        
    except Exception as e:
        print(f"‚ùå Error en configuraci√≥n de removedor: {e}")
        traceback.print_exc()
        return False

def test_factory():
    """Prueba el factory de removedores de fondo."""
    print("\\nüè≠ Probando BackgroundRemoverFactory...")
    print("-" * 45)
    
    try:
        from src.background_remover_factory import BackgroundRemoverFactory
        
        # Verificar tipos disponibles
        available_types = BackgroundRemoverFactory.get_available_types()
        print(f"üì¶ Tipos disponibles: {available_types}")
        
        # Verificar si TutanchaconBgRemover est√° disponible
        tutanchacon_available = BackgroundRemoverFactory.is_tutanchacon_available()
        print(f"üé® TutanchaconBgRemover: {'‚úÖ Disponible' if tutanchacon_available else '‚ùå No disponible'}")
        
        # Probar creaci√≥n de removedor API (simulado)
        try:
            api_remover = BackgroundRemoverFactory.create_remover('api', api_key='test_key')
            print("‚úÖ RemoveBgService factory funciona")
        except Exception as e:
            print(f"‚úÖ RemoveBgService factory funciona (error esperado sin API real): {type(e).__name__}")
        
        # Probar creaci√≥n de TutanchaconBgRemover si est√° disponible
        if tutanchacon_available:
            try:
                tutanchacon_remover = BackgroundRemoverFactory.create_remover('tutanchacon')
                print(f"‚úÖ TutanchaconBgRemover factory: {type(tutanchacon_remover).__name__}")
            except Exception as e:
                print(f"‚ö†Ô∏è TutanchaconBgRemover factory error: {e}")
        
        print("‚úÖ Factory funcionando correctamente")
        return True
        
    except Exception as e:
        print(f"‚ùå Error en factory: {e}")
        traceback.print_exc()
        return False

def test_directories():
    """Prueba que los directorios existan o se puedan crear."""
    print("\\nüìÅ Probando estructura de directorios...")
    print("-" * 45)
    
    try:
        from config import Config
        
        directories = [
            Config.APPROVED_IMAGES_DIR,
            Config.CROPPED_IMAGES_DIR
        ]
        
        for directory in directories:
            if os.path.exists(directory):
                print(f"‚úÖ {directory} existe")
            else:
                os.makedirs(directory, exist_ok=True)
                print(f"‚úÖ {directory} creado")
        
        # Verificar directorio model
        model_dir = "model"
        if os.path.exists(model_dir):
            print(f"‚úÖ {model_dir} existe")
            
            # Verificar archivo Haar Cascade
            haar_file = os.path.join(model_dir, Config.HAAR_CASCADE_PATH)
            if os.path.exists(haar_file):
                print(f"‚úÖ {Config.HAAR_CASCADE_PATH} encontrado")
            else:
                print(f"‚ö†Ô∏è {Config.HAAR_CASCADE_PATH} no encontrado")
        else:
            print(f"‚ö†Ô∏è {model_dir} no existe")
        
        print("‚úÖ Estructura de directorios v√°lida")
        return True
        
    except Exception as e:
        print(f"‚ùå Error con directorios: {e}")
        traceback.print_exc()
        return False

def test_dependencies():
    """Prueba que las dependencias est√©n instaladas."""
    print("\\nüì¶ Probando dependencias...")
    print("-" * 35)
    
    dependencies = [
        ('opencv-python', 'cv2'),
        ('pillow', 'PIL'),
        ('numpy', 'numpy'),
        ('requests', 'requests'),
        ('matplotlib', 'matplotlib'),
        ('python-dotenv', 'dotenv'),
        ('rembg', 'rembg'),
        ('scipy', 'scipy')
    ]
    
    installed = 0
    for package_name, import_name in dependencies:
        try:
            __import__(import_name)
            print(f"‚úÖ {package_name}")
            installed += 1
        except ImportError:
            print(f"‚ùå {package_name} no instalado")
    
    print(f"\\nüìä Dependencias: {installed}/{len(dependencies)} instaladas")
    return installed >= len(dependencies) - 2  # Permitir que falten m√°ximo 2

def test_sample_images():
    """Verifica si hay im√°genes de muestra para probar."""
    print("\\nüñºÔ∏è Verificando im√°genes de muestra...")
    print("-" * 40)
    
    sample_dirs = [
        "avatar_formato ejemplo",
        "p2_approvedimages",
        "p1_rawimages"
    ]
    
    found_images = False
    
    for directory in sample_dirs:
        if os.path.exists(directory):
            images = [f for f in os.listdir(directory) 
                     if f.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp', '.tiff'))]
            
            if images:
                print(f"‚úÖ {directory}: {len(images)} im√°genes encontradas")
                found_images = True
                
                # Mostrar algunas im√°genes de muestra
                for img in images[:3]:
                    print(f"   üì∏ {img}")
                if len(images) > 3:
                    print(f"   ... y {len(images) - 3} m√°s")
            else:
                print(f"‚ö†Ô∏è {directory}: sin im√°genes")
        else:
            print(f"‚ö†Ô∏è {directory}: no existe")
    
    if not found_images:
        print("üí° Para probar el procesamiento, coloca im√°genes en:")
        print("   - avatar_formato ejemplo/")
        print("   - p2_approvedimages/")
    
    return found_images

def test_main_scripts():
    """Prueba que los scripts principales se puedan importar."""
    print("\\nüìú Probando scripts principales...")
    print("-" * 40)
    
    scripts = [
        'resize_images',
        'remove_bg',
        'demo_bg_config',
        'demo_factory',
        'test_tutanchacon_bg_remover'
    ]
    
    working = 0
    for script in scripts:
        try:
            # Solo probar import, no ejecutar
            spec = __import__(script)
            print(f"‚úÖ {script}.py")
            working += 1
        except Exception as e:
            print(f"‚ùå {script}.py: {e}")
    
    print(f"\\nüìä Scripts: {working}/{len(scripts)} importables")
    return working >= len(scripts) - 1  # Permitir que falle m√°ximo 1

def run_comprehensive_test():
    """Ejecuta todos los tests del proyecto."""
    print("üß™ TESTING INTEGRAL - Avatar Image Processor")
    print("=" * 60)
    
    tests = [
        ("Imports", test_imports),
        ("Configuraci√≥n", test_configuration),
        ("Config BG Remover", test_bg_remover_config),
        ("Factory", test_factory),
        ("Directorios", test_directories),
        ("Dependencias", test_dependencies),
        ("Im√°genes muestra", test_sample_images),
        ("Scripts principales", test_main_scripts)
    ]
    
    results = []
    
    for test_name, test_func in tests:
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"\\n‚ùå Error cr√≠tico en {test_name}: {e}")
            results.append((test_name, False))
    
    # Resumen final
    print("\\n" + "=" * 60)
    print("üìä RESUMEN DE TESTING")
    print("=" * 60)
    
    passed = 0
    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status} {test_name}")
        if result:
            passed += 1
    
    success_rate = (passed / len(results)) * 100
    print(f"\\nüéØ Resultado: {passed}/{len(results)} tests exitosos ({success_rate:.1f}%)")
    
    if success_rate >= 80:
        print("üéâ ¬°Proyecto en buen estado para usar!")
        
        if success_rate < 100:
            print("\\nüí° Sugerencias para completar setup:")
            if not any(name == "Dependencias" and result for name, result in results):
                print("   - Ejecutar: pip install -r requirements.txt")
            if not any(name == "Factory" and result for name, result in results):
                print("   - Ejecutar: setup_bgremover.bat")
            if not any(name == "Im√°genes muestra" and result for name, result in results):
                print("   - Agregar im√°genes de prueba en avatar_formato ejemplo/")
    else:
        print("‚ö†Ô∏è El proyecto necesita configuraci√≥n adicional")
        print("\\nüîß Revisar los errores arriba y:")
        print("   1. Instalar dependencias faltantes")
        print("   2. Ejecutar setup_bgremover.bat")
        print("   3. Configurar variables de entorno")
    
    return success_rate >= 80

if __name__ == "__main__":
    run_comprehensive_test()
